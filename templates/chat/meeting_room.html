{% extends 'base.html' %}

{% block title %}{{ meeting.title }} | Teams Meeting{% endblock %}

{% block extra_css %}
<style>
    body {
        margin: 0;
        padding: 0;
        background: #111827;
        color: white;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    #meeting-header {
        height: 60px;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1f2937;
        border-bottom: 1px solid #374151;
        z-index: 10;
    }

    .meeting-info h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .meeting-info p {
        margin: 0;
        font-size: 12px;
        color: #9ca3af;
    }

    #video-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        padding: 20px;
        overflow-y: auto;
        align-content: center;
        justify-content: center;
    }

    .video-container {
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 16/9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-label {
        position: absolute;
        bottom: 12px;
        left: 12px;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #controls-bar {
        height: 80px;
        background: #1f2937;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        padding: 0 24px;
        border-top: 1px solid #374151;
        z-index: 10;
    }

    .control-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: #374151;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .control-btn:hover {
        background: #4b5563;
        transform: translateY(-2px);
    }

    .control-btn svg {
        width: 24px;
        height: 24px;
    }

    .control-btn.active {
        background: #374151;
    }

    .control-btn.inactive {
        background: #ef4444;
    }

    .control-btn.red-btn {
        background: #ef4444;
    }

    .control-btn.red-btn:hover {
        background: #dc2626;
    }

    /* Invite Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #1f2937;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        border: 1px solid #374151;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
</style>
<style>
    /* New styles for Reactions & Hand Raise */
    .video-hand-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #eab308;
        color: black;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 5;
    }

    .video-reaction-emoji {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform: translate(-50%, 50%);
        font-size: 64px;
        animation: floatUp 2s ease-out forwards;
        z-index: 10;
        pointer-events: none;
    }

    @keyframes floatUp {
        0% {
            opacity: 0;
            transform: translate(-50%, 50%) scale(0.5);
        }

        20% {
            opacity: 1;
            transform: translate(-50%, 20%) scale(1.2);
        }

        80% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        100% {
            opacity: 0;
            transform: translate(-50%, -100%) scale(0.8);
        }
    }

    .reactions-popup {
        position: absolute;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        border: 1px solid #374151;
        padding: 10px;
        border-radius: 12px;
        display: none;
        /* hidden by default */
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 20;
    }

    .reactions-popup.active {
        display: flex;
    }

    .reaction-btn {
        background: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.2s;
    }

    .reaction-btn:hover {
        transform: scale(1.2);
    }

    /* Chat Sidebar Styles */
    #meeting-chat-sidebar {
        position: fixed;
        right: -320px;
        top: 61px;
        bottom: 81px;
        width: 300px;
        background: #1f2937;
        border-left: 1px solid #374151;
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 20;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.3);
    }

    #meeting-chat-sidebar.open {
        right: 0;
    }

    .chat-sidebar-header {
        padding: 12px 16px;
        border-bottom: 1px solid #374151;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #111827;
    }

    .chat-sidebar-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
    }

    .chat-sidebar-close:hover {
        background: #374151;
        color: white;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-input-area {
        padding: 12px;
        border-top: 1px solid #374151;
        display: flex;
        gap: 8px;
        background: #111827;
    }

    .chat-input {
        flex: 1;
        background: #374151;
        border: 1px solid #4b5563;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        outline: none;
        font-size: 14px;
    }

    .chat-input:focus {
        border-color: #2563eb;
    }

    .chat-send-btn {
        background: #2563eb;
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .chat-send-btn:hover {
        background: #1d4ed8;
    }

    .chat-msg {
        background: #374151;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
    }

    .chat-msg.self {
        background: #2563eb;
        border-bottom-right-radius: 2px;
        align-self: flex-end;
    }

    .chat-msg:not(.self) {
        border-bottom-left-radius: 2px;
    }

    .chat-msg-header {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        gap: 8px;
    }

    .chat-msg.self .chat-msg-header {
        color: #dbeafe;
        flex-direction: row-reverse;
    }
</style>
{% endblock %}

{% block content %}
<div id="meeting-header">
    <div class="meeting-info">
        <h2>{{ meeting.title }}</h2>
        <p>{{ meeting.id }}</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="showInviteModal()">Add People</button>
    </div>
</div>

<div id="video-grid">
    <!-- Local Video -->
    <div class="video-container" id="video-container-local">
        <video id="local-video" autoplay playsinline muted></video>
        <div class="video-label">
            <span>You</span>
        </div>
    </div>
</div>

<div id="controls-bar">
    <button id="btn-mic" class="control-btn" title="Toggle Mic">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
    </button>

    <button id="btn-cam" class="control-btn" title="Toggle Camera">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
    </button>

    <button id="btn-share" class="control-btn" title="Share Screen" onclick="toggleScreenShare()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
    </button>

    <button id="btn-chat" class="control-btn" title="Chat" onclick="toggleChatSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>

    <div style="position:relative;">
        <button id="btn-react" class="control-btn" title="Reactions" onclick="toggleReactionsPopup()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
        <div id="reactions-popup" class="reactions-popup">
            <button class="reaction-btn" onclick="sendMeetingReaction('üëç')">üëç</button>
            <button class="reaction-btn" onclick="sendMeetingReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="reaction-btn" onclick="sendMeetingReaction('üòÇ')">üòÇ</button>
            <button class="reaction-btn" onclick="sendMeetingReaction('üòÆ')">üòÆ</button>
            <button class="reaction-btn" onclick="sendMeetingReaction('üëè')">üëè</button>
            <button class="reaction-btn" onclick="sendMeetingReaction('üéâ')">üéâ</button>
        </div>
    </div>

    <button id="btn-hand" class="control-btn" title="Raise Hand" onclick="toggleRaiseHand()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11" />
        </svg>
    </button>

    <button id="btn-leave" class="control-btn red-btn" title="Leave Meeting" onclick="leaveMeeting()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
    </button>
</div>



<!-- Chat Sidebar -->
<div id="meeting-chat-sidebar">
    <div class="chat-sidebar-header">
        <h3 style="margin:0; font-size:16px; font-weight:600;">Meeting Chat</h3>
        <button class="chat-sidebar-close" onclick="toggleChatSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will appear here -->
        <div style="text-align:center; color:#6b7280; font-size:12px; margin-top:20px;">Welcome to team chat!</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="meeting-chat-input" class="chat-input" placeholder="Type a message..."
            onkeypress="handleChatInput(event)">
        <button class="chat-send-btn" onclick="sendMeetingChat()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>
</div>

<!-- Invite Modal -->
<div id="invite-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Invite People</h3>
        <p style="color:#9ca3af; font-size:14px; margin-bottom:16px;">Share this link with others to invite them.</p>
        <div style="display:flex; gap:8px;">
            <input type="text" id="meeting-link" readonly
                value="{{ request.scheme }}://{{ request.get_host }}/chat/meeting/{{ meeting.id }}/"
                style="flex:1; background:#111827; border:1px solid #374151; color:white; padding:8px; border-radius:6px; outline:none;">
            <button class="btn-primary" onclick="copyLink()">Copy</button>
        </div>
        <div style="margin-top:16px; text-align:right;">
            <button onclick="document.getElementById('invite-modal').style.display='none'"
                style="background:none; border:none; color:#9ca3af; cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<!-- Meeting Logic -->
<script>
    const MEETING_ID = "{{ meeting.id }}";
    const USER_ID = "{{ user.id }}";
    const IS_HOST = "{{ meeting.host.id }}" === "{{ user.id }}";

    const USERNAME = "{{ user.username }}";
    const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const WS_URL = `${WS_PROTOCOL}//${window.location.host}/ws/meeting/${MEETING_ID}/`;

    async function leaveMeeting() {
        if (IS_HOST) {
            const endForEveryone = confirm("End meeting for everyone?");
            if (endForEveryone) {
                try {
                    await fetch(`/chat/api/meetings/${MEETING_ID}/end/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                } catch (e) { console.error(e); }
            }
        }
        window.location.href = "/chat/";
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // TURN Config
    // const TURN_CONFIG = {{ turn_config|safe }}; NOT USED YET
    const ICE_SERVERS = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    let localStream;
    let peers = {}; // Key: user_id, Value: { pc: RTCPeerConnection, stream: RemoteStream }
    let socket;
    let isHandRaised = false;

    // Elements
    const localVideo = document.getElementById('local-video');
    const videoGrid = document.getElementById('video-grid');

    async function init() {
        try {
            // Get User Media
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
        } catch (e) {
            console.error("Error accessing media devices:", e);
            alert("Could not access camera/microphone.");
        }

        // Connect WebSocket
        connectSocket();
    }

    function connectSocket() {
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            console.log("Connected to Meeting Server");
        };

        socket.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            handleSignalingData(data);
        };

        socket.onclose = () => {
            console.log("Disconnected. Reconnecting...");
            setTimeout(connectSocket, 2000);
        };
    }

    async function handleSignalingData(data) {
        switch (data.type) {
            case 'user-joined':
                console.log("User Joined:", data.username);
                // Create Offer
                createPeerConnection(data.user_id, true);
                break;

            case 'user-left':
                console.log("User Left:", data.user_id);
                removePeer(data.user_id);
                break;

            case 'signal':
                await handleSignalMessage(data);
                break;

            case 'raise-hand':
                updateRemoteHandStatus(data.user_id, data.is_raised);
                break;

            case 'reaction':
                showRemoteReaction(data.user_id, data.emoji);
                break;

            case 'chat-message':
                appendChatMessage(data);
                break;
        }
    }

    // WebRTC Logic
    async function createPeerConnection(remoteUserId, isInitiator) {
        if (peers[remoteUserId]) return peers[remoteUserId];

        const pc = new RTCPeerConnection(ICE_SERVERS);

        // Add Local Tracks
        if (localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        // Handle Remote Tracks
        pc.ontrack = (event) => {
            const remoteStream = event.streams[0];
            let videoContainer = document.getElementById(`video-container-${remoteUserId}`);

            if (!videoContainer) {
                // Create video element
                videoContainer = document.createElement('div');
                videoContainer.className = 'video-container';
                videoContainer.id = `video-container-${remoteUserId}`;

                const videoEl = document.createElement('video');
                videoEl.autoplay = true;
                videoEl.playsInline = true;
                videoEl.srcObject = remoteStream;

                const label = document.createElement('div');
                label.className = 'video-label';
                label.innerText = `User ${remoteUserId}`; // Could fetch real name if passed

                videoContainer.appendChild(videoEl);
                videoContainer.appendChild(label);
                videoGrid.appendChild(videoContainer);

                // Initial Hand Check if needed (requires state sync, skipping for MVP)
            }
        };

        // ICE Candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignal('candidate', { candidate: event.candidate }, remoteUserId);
            }
        };

        peers[remoteUserId] = { pc: pc };

        if (isInitiator) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal('offer', { sdp: offer }, remoteUserId);
        }

        return pc;
    }

    async function handleSignalMessage(message) {
        const { sender_id, data } = message;

        let pc = peers[sender_id]?.pc;
        if (!pc) {
            // If we receive an offer, we are not initiator
            pc = await createPeerConnection(sender_id, false);
        }

        if (data.sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            if (data.sdp.type === 'offer') {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal('answer', { sdp: answer }, sender_id);
            }
        } else if (data.candidate) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (e) {
                console.error("Error adding Ice Candidate", e);
            }
        }
    }

    function sendSignal(type, data, targetUserId) {
        socket.send(JSON.stringify({
            type: 'signal',
            target: targetUserId,
            data: data
        }));
    }

    function removePeer(userId) {
        if (peers[userId]) {
            peers[userId].pc.close();
            delete peers[userId];
        }
        const el = document.getElementById(`video-container-${userId}`);
        if (el) el.remove();
    }

    // UI Actions
    document.getElementById('btn-mic').onclick = () => {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        document.getElementById('btn-mic').classList.toggle('inactive', !track.enabled);
    };

    document.getElementById('btn-cam').onclick = () => {
        const track = localStream.getVideoTracks()[0];
        track.enabled = !track.enabled;
        document.getElementById('btn-cam').classList.toggle('inactive', !track.enabled);
    };

    let isScreenSharing = false;
    let originalVideoTrack = null;

    async function toggleScreenShare() {
        if (isScreenSharing) {
            stopScreenShare();
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const screenTrack = stream.getVideoTracks()[0];

            if (!localStream) {
                console.warn("No local stream");
                return;
            }

            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                originalVideoTrack = videoTracks[0];
                localStream.removeTrack(originalVideoTrack);
            }

            localStream.addTrack(screenTrack);

            // Update Local Video
            const localVideo = document.getElementById('local-video');
            if (localVideo) localVideo.srcObject = localStream;

            // Replace track in peers
            Object.values(peers).forEach(p => {
                if (p.pc) {
                    const sender = p.pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(screenTrack).catch(e => console.error("ReplaceTrack Error", e));
                    }
                }
            });

            // Handle stop via browser UI
            screenTrack.onended = () => stopScreenShare();

            isScreenSharing = true;
            document.getElementById('btn-share').style.background = '#2563eb';

        } catch (e) {
            console.error("Error sharing screen", e);
        }
    }

    function stopScreenShare() {
        if (!localStream) return;
        const screenTrack = localStream.getVideoTracks()[0];
        if (screenTrack) {
            screenTrack.stop();
            localStream.removeTrack(screenTrack);
        }

        if (originalVideoTrack) {
            localStream.addTrack(originalVideoTrack);
            originalVideoTrack.enabled = true; // Ensure it's on
        }

        // Update Local Video
        const localVideo = document.getElementById('local-video');
        if (localVideo) localVideo.srcObject = localStream;

        // Restore track in peers
        Object.values(peers).forEach(p => {
            if (p.pc) {
                const sender = p.pc.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender && originalVideoTrack) {
                    sender.replaceTrack(originalVideoTrack).catch(e => console.error("RestoreTrack Error", e));
                }
            }
        });

        isScreenSharing = false;
        originalVideoTrack = null;
        document.getElementById('btn-share').style.background = '#374151';

        // Restore cam button state if needed
        const camBtn = document.getElementById('btn-cam');
        if (originalVideoTrack && !originalVideoTrack.enabled) {
            camBtn.classList.add('inactive');
        } else {
            camBtn.classList.remove('inactive');
        }
    }



    function showInviteModal() {
        document.getElementById('invite-modal').style.display = "flex";
    }

    function copyLink() {
        const copyText = document.getElementById("meeting-link");
        copyText.select();
        document.execCommand("copy");
        alert("Link copied!");
    }

    // --- REACTION & HAND RAISE LOGIC ---

    function toggleReactionsPopup() {
        const popup = document.getElementById('reactions-popup');
        popup.classList.toggle('active');
    }

    // Close popup on click outside
    document.addEventListener('click', (e) => {
        const popup = document.getElementById('reactions-popup');
        const btn = document.getElementById('btn-react');
        if (popup && popup.classList.contains('active') && !popup.contains(e.target) && !btn.contains(e.target)) {
            popup.classList.remove('active');
        }
    });

    function sendMeetingReaction(emoji) {
        document.getElementById('reactions-popup').classList.remove('active');

        // Show local reaction on local video
        showRemoteReaction(USER_ID, emoji);

        socket.send(JSON.stringify({
            type: 'reaction',
            emoji: emoji
        }));
    }

    function toggleRaiseHand() {
        isHandRaised = !isHandRaised;

        // Update local button style
        const btn = document.getElementById('btn-hand');
        if (isHandRaised) {
            btn.style.background = '#eab308';
            btn.style.color = '#000';
        } else {
            btn.style.background = ''; // reset to class default
            btn.style.color = '';
        }

        // Update local video badge
        updateRemoteHandStatus(USER_ID, isHandRaised);

        socket.send(JSON.stringify({
            type: 'raise_hand',
            is_raised: isHandRaised
        }));
    }

    function updateRemoteHandStatus(userId, isRaised) {
        let containerId = `video-container-${userId}`;
        if (userId == USER_ID) containerId = 'video-container-local';

        const container = document.getElementById(containerId);
        if (!container) return;

        let badge = container.querySelector('.video-hand-badge');
        if (isRaised) {
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'video-hand-badge';
                badge.textContent = '‚úã';
                container.appendChild(badge);
            }
        } else {
            if (badge) badge.remove();
        }
    }

    function showRemoteReaction(userId, emoji) {
        let containerId = `video-container-${userId}`;
        if (userId == USER_ID) containerId = 'video-container-local';

        const container = document.getElementById(containerId);
        if (!container) return;

        const el = document.createElement('div');
        el.className = 'video-reaction-emoji';
        el.textContent = emoji;
        container.appendChild(el);

        // Remove after animation
        setTimeout(() => {
            el.remove();
        }, 2000);
    }

    // Start
    init();

    // --- CHAT LOGIC ---
    function toggleChatSidebar() {
        const sidebar = document.getElementById('meeting-chat-sidebar');
        const btn = document.getElementById('btn-chat');
        sidebar.classList.toggle('open');
        btn.classList.toggle('active', sidebar.classList.contains('open'));

        // Auto focus input if opening
        if (sidebar.classList.contains('open')) {
            setTimeout(() => document.getElementById('meeting-chat-input').focus(), 300);
        }
    }

    function handleChatInput(e) {
        if (e.key === 'Enter') {
            sendMeetingChat();
        }
    }

    function sendMeetingChat() {
        const input = document.getElementById('meeting-chat-input');
        const text = input.value.trim();
        if (!text) return;

        socket.send(JSON.stringify({
            type: 'chat_message',
            text: text
        }));

        input.value = '';
    }

    function appendChatMessage(data) {
        const container = document.getElementById('chat-messages');
        const isSelf = data.sender_id == USER_ID;

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-msg ${isSelf ? 'self' : ''}`;

        const header = document.createElement('div');
        header.className = 'chat-msg-header';
        header.innerHTML = `<span>${isSelf ? 'You' : data.username}</span><span>${data.timestamp}</span>`;

        const content = document.createElement('div');
        content.textContent = data.text;

        msgDiv.appendChild(header);
        msgDiv.appendChild(content);

        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

</script>
{% endblock %}